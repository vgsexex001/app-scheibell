generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String               @id @default(uuid())
  authId               String?              @unique
  email                String               @unique
  passwordHash         String
  name                 String
  role                 UserRole             @default(PATIENT)
  clinicId             String?
  failedLoginAttempts  Int                  @default(0)
  lockedUntil          DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  deletedAt            DateTime?
  uploadedDocuments    ClinicDocument[]     @relation("UploadedDocuments")
  uploadedVideos       ClinicVideo[]        @relation("UploadedVideos")
  loginAttempts        LoginAttempt[]
  notifications        Notification[]
  passwordResetTokens  PasswordResetToken[]
  generatedConnections PatientConnection[]  @relation("GeneratedConnections")
  patient              Patient?
  refreshTokens        RefreshToken[]
  clinic               Clinic?              @relation(fields: [clinicId], references: [id])

  // Multi-clínica: associações
  clinicAssignments          UserClinicAssignment[]       @relation()
  createdUserAssignments     UserClinicAssignment[]       @relation("CreatedUserAssignments")
  createdPatientAssociations PatientClinicAssociation[]   @relation("CreatedPatientAssociations")

  @@index([clinicId])
  @@index([role])
  @@index([email])
  @@index([authId])
  @@map("users")
}

model LoginAttempt {
  id         String   @id @default(uuid())
  userId     String?
  email      String
  ipAddress  String?
  userAgent  String?
  success    Boolean  @default(false)
  failReason String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([createdAt])
  @@map("login_attempts")
}

model Clinic {
  id                 String              @id @default(uuid())
  name               String
  email              String?
  phone              String?
  address            String?
  logoUrl            String?
  primaryColor       String?             @default("#4F4A34")
  secondaryColor     String?             @default("#A49E86")
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  deletedAt          DateTime?
  alerts             Alert[]
  appointments       Appointment[]
  blockedDates       ClinicBlockedDate[]
  contents           ClinicContent[]
  documents          ClinicDocument[]
  schedules          ClinicSchedule[]
  videos             ClinicVideo[]
  contentTemplates   ContentTemplate[]
  patientConnections PatientConnection[]
  patients           Patient[]
  trainingProtocols  TrainingProtocol[]
  users              User[]

  // Multi-clínica: associações N:N
  patientAssociations PatientClinicAssociation[] @relation("ClinicPatientAssociations")
  userAssignments     UserClinicAssignment[]     @relation("ClinicUserAssignments")
  transferredPatients PatientClinicAssociation[] @relation("TransferredFromClinic")

  @@index([isActive])
  @@map("clinics")
}

model Patient {
  id                 String                     @id @default(uuid())
  userId             String?                    @unique
  name               String?
  email              String?
  clinicId           String
  cpf                String?
  phone              String?
  birthDate          DateTime?
  bloodType          String?
  weightKg           Float?
  heightCm           Float?
  emergencyContact   String?
  emergencyPhone     String?
  surgeryDate        DateTime?
  surgeryType        String?
  surgeon            String?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  deletedAt          DateTime?
  alerts             Alert[]
  appointments       Appointment[]
  chatConversations  ChatConversation[]
  exams              Exam[]
  externalEvents     ExternalEvent[]
  medicalNotes       MedicalNote[]
  medicationLogs     MedicationLog[]
  allergies          PatientAllergy[]
  connections        PatientConnection[]
  contentAdjustments PatientContentAdjustment[]
  contentOverrides   PatientContentOverride[]
  contentState       PatientContentState?
  sessionCompletions PatientSessionCompletion[]
  tasks              PatientTask[]
  trainingProgress   PatientTrainingProgress[]
  clinic             Clinic                     @relation(fields: [clinicId], references: [id])
  user               User?                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  videoProgress      VideoProgress[]

  // Multi-clínica: associações com múltiplas clínicas
  clinicAssociations PatientClinicAssociation[]

  @@index([clinicId])
  @@index([clinicId, surgeryType])
  @@map("patients")
}

model ClinicSchedule {
  id              String           @id @default(uuid())
  clinicId        String
  dayOfWeek       Int
  openTime        String
  closeTime       String
  slotDuration    Int              @default(30)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  breakEnd        String?
  breakStart      String?
  appointmentType AppointmentType?
  maxAppointments Int?
  clinic          Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@unique([clinicId, dayOfWeek, appointmentType])
  @@index([clinicId])
  @@index([clinicId, appointmentType])
  @@map("clinic_schedules")
}

model ClinicBlockedDateByType {
  id              String          @id @default(uuid())
  clinicId        String
  appointmentType AppointmentType
  date            DateTime
  reason          String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([clinicId, appointmentType, date])
  @@index([clinicId, appointmentType])
  @@map("clinic_blocked_dates_by_type")
}

model ClinicBlockedDate {
  id        String   @id @default(uuid())
  clinicId  String
  date      DateTime
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@unique([clinicId, date])
  @@index([clinicId])
  @@index([clinicId, date])
  @@map("clinic_blocked_dates")
}

model Appointment {
  id          String            @id @default(uuid())
  patientId   String
  clinicId    String
  title       String
  description String?
  date        DateTime
  time        String
  type        AppointmentType
  status      AppointmentStatus @default(PENDING)
  location    String?
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?
  duration    Int               @default(30)
  clinic      Clinic            @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient     Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([patientId, status])
  @@index([patientId, date])
  @@index([status])
  @@index([date, time])
  @@map("appointments")
}

model MedicationLog {
  id            String   @id @default(uuid())
  patientId     String
  contentId     String
  takenAt       DateTime @default(now())
  scheduledTime String
  createdAt     DateTime @default(now())
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([patientId, takenAt])
  @@map("medication_logs")
}

model Exam {
  id               String            @id @default(uuid())
  patientId        String
  title            String
  type             String
  date             DateTime
  status           ExamStatus        @default(PENDING)
  fileUrl          String?
  fileName         String?
  fileSize         Int?
  mimeType         String?
  notes            String?
  result           String?
  fileType         PatientFileType   @default(EXAM)
  aiStatus         AiAnalysisStatus  @default(PENDING)
  aiSummary        String?
  aiJson           Json?
  aiAnalyzedAt     DateTime?
  aiConfidence     Float?
  resultStatus     ExamResultStatus?
  approvedAnalysis String?
  approvedBy       String?
  approvedAt       DateTime?
  createdByRole    String?
  createdById      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  patient          Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([patientId, status])
  @@index([patientId, date])
  @@index([patientId, fileType])
  @@index([patientId, fileType, createdAt(sort: Desc)])
  @@index([status])
  @@map("exams")
}

model SystemContentTemplate {
  id            String          @id @default(uuid())
  type          ContentType
  category      ContentCategory
  title         String
  description   String?
  validFromDay  Int?
  validUntilDay Int?
  sortOrder     Int             @default(0)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([type])
  @@index([type, category])
  @@map("system_content_templates")
}

model ClinicContent {
  id                 String                     @id @default(uuid())
  clinicId           String
  templateId         String?
  type               ContentType
  category           ContentCategory
  title              String
  description        String?
  validFromDay       Int?
  validUntilDay      Int?
  sortOrder          Int                        @default(0)
  isActive           Boolean                    @default(true)
  isCustom           Boolean                    @default(false)
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  clinic             Clinic                     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patientAdjustments PatientContentAdjustment[]

  @@index([clinicId])
  @@index([clinicId, type])
  @@index([clinicId, type, category])
  @@index([clinicId, type, isActive])
  @@map("clinic_contents")
}

model PatientContentAdjustment {
  id             String           @id @default(uuid())
  patientId      String
  baseContentId  String?
  adjustmentType AdjustmentType
  contentType    ContentType?
  category       ContentCategory?
  title          String?
  description    String?
  validFromDay   Int?
  validUntilDay  Int?
  canDo          String[]
  avoid          String[]
  reason         String?
  isActive       Boolean          @default(true)
  createdBy      String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  baseContent    ClinicContent?   @relation(fields: [baseContentId], references: [id], onDelete: Cascade)
  patient        Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([baseContentId])
  @@map("patient_content_adjustments")
}

/// Protocolo de treino padrão (configurado pela clínica ou sistema)
model TrainingProtocol {
  id          String         @id @default(uuid())
  clinicId    String?
  name        String
  surgeryType String?
  description String?
  totalWeeks  Int            @default(8)
  isDefault   Boolean        @default(false)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  clinic      Clinic?        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  weeks       TrainingWeek[]

  @@index([clinicId])
  @@index([isDefault])
  @@map("training_protocols")
}

/// Semana do protocolo de treino
model TrainingWeek {
  id             String                    @id @default(uuid())
  protocolId     String
  weekNumber     Int
  title          String
  dayRange       String
  objective      String
  maxHeartRate   Int?
  heartRateLabel String?
  canDo          String[]
  avoid          String[]
  safetyCriteria String[]
  sortOrder      Int                       @default(0)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  progress       PatientTrainingProgress[]
  sessions       TrainingSession[]
  protocol       TrainingProtocol          @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  @@unique([protocolId, weekNumber])
  @@index([protocolId])
  @@map("training_weeks")
}

/// Sessão de treino (ex: 3 sessões por semana)
model TrainingSession {
  id            String                     @id @default(uuid())
  weekId        String
  sessionNumber Int
  name          String
  description   String?
  duration      Int?
  intensity     String?
  sortOrder     Int                        @default(0)
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  completions   PatientSessionCompletion[]
  week          TrainingWeek               @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@unique([weekId, sessionNumber])
  @@index([weekId])
  @@map("training_sessions")
}

/// Progresso do paciente na semana
model PatientTrainingProgress {
  id          String             @id @default(uuid())
  patientId   String
  weekId      String
  status      TrainingWeekStatus @default(FUTURE)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  patient     Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  week        TrainingWeek       @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@unique([patientId, weekId])
  @@index([patientId])
  @@index([patientId, status])
  @@map("patient_training_progress")
}

/// Registro de conclusão de sessão de treino
model PatientSessionCompletion {
  id          String          @id @default(uuid())
  patientId   String
  sessionId   String
  completedAt DateTime        @default(now())
  notes       String?
  patient     Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  session     TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([patientId, sessionId])
  @@index([patientId])
  @@index([patientId, completedAt])
  @@map("patient_session_completions")
}

model ChatConversation {
  id             String           @id @default(uuid())
  patientId      String
  mode           ChatMode         @default(AI)
  handoffAt      DateTime?
  handoffAlertId String?
  closedAt       DateTime?
  closedBy       String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  attachments    ChatAttachment[]
  patient        Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  messages       ChatMessage[]

  @@index([patientId])
  @@index([mode])
  @@map("chat_conversations")
}

model ChatMessage {
  id             String           @id @default(uuid())
  conversationId String
  role           String
  content        String
  senderId       String?
  senderType     String?
  createdAt      DateTime         @default(now())
  attachments    ChatAttachment[]
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("chat_messages")
}

model ChatAttachment {
  id              String               @id @default(uuid())
  messageId       String?
  conversationId  String
  type            ChatAttachmentType   @default(IMAGE)
  originalName    String
  storagePath     String
  mimeType        String
  sizeBytes       Int
  status          ChatAttachmentStatus @default(PENDING)
  aiAnalysis      String?
  errorMessage    String?
  createdAt       DateTime             @default(now())
  processedAt     DateTime?
  durationSeconds Int?
  transcribedAt   DateTime?
  transcription   String?
  conversation    ChatConversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message         ChatMessage?         @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([conversationId])
  @@index([conversationId, status])
  @@map("chat_attachments")
}

model Alert {
  id          String      @id @default(uuid())
  clinicId    String
  patientId   String?
  type        AlertType
  title       String
  description String?
  status      AlertStatus @default(ACTIVE)
  isAutomatic Boolean     @default(false)
  createdAt   DateTime    @default(now())
  resolvedAt  DateTime?
  resolvedBy  String?
  clinic      Clinic      @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient     Patient?    @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([clinicId, status])
  @@index([patientId])
  @@index([type])
  @@index([createdAt])
  @@map("alerts")
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  status    NotificationStatus @default(PENDING)
  sentAt    DateTime?
  readAt    DateTime?
  createdAt DateTime           @default(now())
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

model PatientAllergy {
  id        String   @id @default(uuid())
  patientId String
  name      String
  severity  String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_allergies")
}

model MedicalNote {
  id        String   @id @default(uuid())
  patientId String
  content   String
  author    String?
  authorId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([patientId, createdAt])
  @@map("medical_notes")
}

model PatientConnection {
  id              String           @id @default(uuid())
  patientId       String
  clinicId        String
  connectionCode  String           @unique
  status          ConnectionStatus @default(PENDING)
  codeGeneratedAt DateTime         @default(now())
  codeExpiresAt   DateTime
  connectedAt     DateTime?
  revokedAt       DateTime?
  generatedById   String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  clinic          Clinic           @relation(fields: [clinicId], references: [id])
  generatedBy     User             @relation("GeneratedConnections", fields: [generatedById], references: [id])
  patient         Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([connectionCode])
  @@index([patientId])
  @@index([clinicId])
  @@index([status])
  @@map("patient_connections")
}

/// Templates globais de conteúdo da clínica
model ContentTemplate {
  id            String                   @id @default(uuid())
  clinicId      String
  type          ContentType
  category      ContentCategory
  title         String
  description   String?
  validFromDay  Int?
  validUntilDay Int?
  sortOrder     Int                      @default(0)
  isActive      Boolean                  @default(true)
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  createdBy     String?
  clinic        Clinic                   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  overrides     PatientContentOverride[]

  @@index([clinicId])
  @@index([clinicId, type])
  @@index([clinicId, type, isActive])
  @@map("content_templates")
}

/// Personalizações de conteúdo por paciente
model PatientContentOverride {
  id            String           @id @default(uuid())
  patientId     String
  templateId    String?
  action        OverrideAction
  type          ContentType?
  category      ContentCategory?
  title         String?
  description   String?
  validFromDay  Int?
  validUntilDay Int?
  reason        String?
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  createdBy     String?
  patient       Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  template      ContentTemplate? @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([patientId, templateId])
  @@index([patientId, action])
  @@map("patient_content_overrides")
}

/// Estado de sincronização de conteúdo do paciente
model PatientContentState {
  id           String   @id @default(uuid())
  patientId    String   @unique
  version      Int      @default(1)
  lastSyncedAt DateTime @default(now())
  contentHash  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  patient      Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("patient_content_states")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id         String    @id @default(uuid())
  userId     String
  token      String    @unique
  deviceInfo String?
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

model ExternalEvent {
  id        String    @id @default(uuid())
  patientId String
  title     String
  date      DateTime
  time      String
  location  String?
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  patient   Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([patientId, date])
  @@map("external_events")
}

model VideoProgress {
  id              String    @id @default(uuid())
  patientId       String
  contentId       String
  watchedSeconds  Int       @default(0)
  totalSeconds    Int
  progressPercent Float     @default(0)
  isCompleted     Boolean   @default(false)
  lastWatchedAt   DateTime  @default(now())
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  patient         Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([patientId, contentId])
  @@index([patientId])
  @@index([contentId])
  @@index([patientId, isCompleted])
  @@map("video_progress")
}

model PatientTask {
  id             String              @id @default(uuid())
  patientId      String
  clinicId       String
  title          String
  description    String?
  category       TaskCategory        @default(CARE)
  priority       TaskPriority        @default(MEDIUM)
  scheduledDate  DateTime?
  scheduledTime  String?
  dueDate        DateTime?
  isRecurring    Boolean             @default(false)
  recurrenceRule String?
  validFromDay   Int?
  validUntilDay  Int?
  status         TaskStatus          @default(PENDING)
  completedAt    DateTime?
  completedNote  String?
  sourceType     TaskSource          @default(CLINIC)
  sourceId       String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  patient        Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  completionLogs TaskCompletionLog[]

  @@index([patientId, status])
  @@index([patientId, scheduledDate])
  @@index([clinicId])
  @@map("patient_tasks")
}

model TaskCompletionLog {
  id           String      @id @default(uuid())
  taskId       String
  patientId    String
  completedAt  DateTime    @default(now())
  scheduledFor DateTime
  notes        String?
  task         PatientTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([patientId, scheduledFor])
  @@index([taskId])
  @@map("task_completion_logs")
}

model Job {
  id          String    @id @default(uuid())
  type        JobType
  status      JobStatus @default(PENDING)
  payload     Json
  result      Json?
  error       String?
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  scheduledAt DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([type, status])
  @@index([scheduledAt])
  @@map("jobs")
}

model ClinicVideo {
  id               String         @id @default(uuid())
  clinicId         String
  title            String
  description      String?
  videoUrl         String
  thumbnailUrl     String?
  category         MediaCategory  @default(GERAL)
  duration         Int?
  sortOrder        Int            @default(0)
  isActive         Boolean        @default(true)
  uploadedById     String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  subtitleError    String?
  subtitleLanguage String?        @default("pt")
  subtitleStatus   SubtitleStatus @default(PENDING)
  subtitleUrl      String?
  clinic           Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  uploadedBy       User?          @relation("UploadedVideos", fields: [uploadedById], references: [id])

  @@index([clinicId])
  @@index([clinicId, category])
  @@index([clinicId, isActive])
  @@map("clinic_videos")
}

model ClinicDocument {
  id           String        @id @default(uuid())
  clinicId     String
  title        String
  description  String?
  fileUrl      String
  fileType     String
  fileName     String
  fileSize     Int?
  category     MediaCategory @default(GERAL)
  isPublic     Boolean       @default(true)
  sortOrder    Int           @default(0)
  isActive     Boolean       @default(true)
  uploadedById String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  clinic       Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  uploadedBy   User?         @relation("UploadedDocuments", fields: [uploadedById], references: [id])

  @@index([clinicId])
  @@index([clinicId, category])
  @@index([clinicId, isActive])
  @@map("clinic_documents")
}

enum ContentType {
  SYMPTOMS
  DIET
  ACTIVITIES
  CARE
  TRAINING
  EXAMS
  DOCUMENTS
  MEDICATIONS
  DIARY
}

enum ContentCategory {
  NORMAL
  WARNING
  EMERGENCY
  ALLOWED
  RESTRICTED
  PROHIBITED
  INFO
}

enum AdjustmentType {
  ADD
  DISABLE
  MODIFY
}

enum OverrideAction {
  ADD
  DISABLE
  MODIFY
}

enum UserRole {
  PATIENT
  CLINIC_ADMIN
  CLINIC_STAFF
  THIRD_PARTY
}

enum AppointmentType {
  CONSULTATION
  RETURN_VISIT
  EVALUATION
  SPLINT_REMOVAL
  PHYSIOTHERAPY
  EXAM
  SURGERY
  OTHER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum ExamStatus {
  PENDING
  PENDING_REVIEW
  AVAILABLE
  VIEWED
}

enum ExamResultStatus {
  NORMAL
  MILD_ALTERATION
  NEEDS_REVIEW
  CRITICAL
}

enum PatientFileType {
  EXAM
  DOCUMENT
}

enum AiAnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SKIPPED
}

enum AlertType {
  HIGH_PAIN
  FEVER
  LOW_ADHERENCE
  MISSED_APPOINTMENT
  URGENT_SYMPTOM
  HUMAN_HANDOFF
  OTHER
}

enum AlertStatus {
  ACTIVE
  RESOLVED
  DISMISSED
}

enum NotificationType {
  NEW_APPOINTMENT
  APPOINTMENT_APPROVED
  APPOINTMENT_REJECTED
  ALERT_CREATED
  REMINDER
  OTHER
}

enum NotificationStatus {
  PENDING
  SENT
  READ
  FAILED
}

enum ConnectionStatus {
  PENDING
  ACTIVE
  REVOKED
  EXPIRED
}

enum ChatAttachmentType {
  IMAGE
  AUDIO
}

enum ChatAttachmentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ChatMode {
  AI
  HUMAN
  CLOSED
}

enum TrainingWeekStatus {
  COMPLETED
  CURRENT
  FUTURE
}

enum TaskCategory {
  CARE
  MEDICATION
  EXERCISE
  DIET
  HYGIENE
  REST
  APPOINTMENT
  CUSTOM
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  OVERDUE
}

enum TaskSource {
  CLINIC
  SYSTEM
  PATIENT
  TRAINING
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum JobType {
  CHAT_AI_REPLY
  IMAGE_ANALYZE
  NOTIFY_ADMIN
  SEND_NOTIFICATION
}

enum MediaCategory {
  GERAL
  EXERCICIO
  POS_OPERATORIO
  ORIENTACAO
  CONSENTIMENTO
  RESULTADO
}

enum SubtitleStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// =====================================================
// MULTI-CLÍNICA: Tabelas de Associação
// =====================================================

/// Status da associação paciente-clínica
enum PatientClinicStatus {
  ACTIVE
  INACTIVE
  TRANSFERRED
}

/// Associação N:N entre Pacientes e Clínicas
model PatientClinicAssociation {
  id                      String              @id @default(uuid())
  patientId               String              @map("patient_id")
  clinicId                String              @map("clinic_id")

  // Dados específicos desta associação
  surgeryDate             DateTime?           @map("surgery_date")
  surgeryType             String?             @map("surgery_type")
  surgeon                 String?

  // Controle de status
  status                  PatientClinicStatus @default(ACTIVE)
  isPrimary               Boolean             @default(false) @map("is_primary")

  // Histórico de transferência
  transferredFromClinicId String?             @map("transferred_from_clinic_id")
  transferReason          String?             @map("transfer_reason")
  transferredAt           DateTime?           @map("transferred_at")

  // Auditoria
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @default(now()) @updatedAt @map("updated_at")
  createdById             String?             @map("created_by")

  // Relacionamentos
  patient                 Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  clinic                  Clinic              @relation("ClinicPatientAssociations", fields: [clinicId], references: [id], onDelete: Cascade)
  transferredFromClinic   Clinic?             @relation("TransferredFromClinic", fields: [transferredFromClinicId], references: [id])
  createdBy               User?               @relation("CreatedPatientAssociations", fields: [createdById], references: [id])

  @@unique([patientId, clinicId])
  @@index([patientId])
  @@index([clinicId])
  @@index([status])
  @@map("patient_clinic_associations")
}

/// Role específica por clínica
enum ClinicAssignmentRole {
  CLINIC_ADMIN
  CLINIC_STAFF
  VIEWER
}

/// Associação N:N entre Usuários (staff) e Clínicas
model UserClinicAssignment {
  id          String               @id @default(uuid())
  userId      String               @map("user_id")
  clinicId    String               @map("clinic_id")

  // Role específica nesta clínica
  role        ClinicAssignmentRole

  // Permissões granulares
  permissions Json                 @default("[]")

  // Controle de status
  isActive    Boolean              @default(true) @map("is_active")
  isDefault   Boolean              @default(false) @map("is_default")

  // Auditoria
  startedAt   DateTime             @default(now()) @map("started_at")
  endedAt     DateTime?            @map("ended_at")
  createdById String?              @map("created_by")

  // Relacionamentos
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic      Clinic               @relation("ClinicUserAssignments", fields: [clinicId], references: [id], onDelete: Cascade)
  createdBy   User?                @relation("CreatedUserAssignments", fields: [createdById], references: [id])

  @@unique([userId, clinicId])
  @@index([userId])
  @@index([clinicId])
  @@map("user_clinic_assignments")
}
